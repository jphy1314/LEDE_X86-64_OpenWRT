name: Build Armbian for H618

on:
  workflow_dispatch:
    inputs:
      board:
        description: 'H618 支持的板型（已限制）'
        required: true
        type: choice
        default: orangepizero3
        options:
          - orangepizero3
          - orangepipc
      branch:
        description: '内核分支'
        required: true
        default: current
        type: choice
        options:
          - current
          - edge
      release:
        description: '发行版'
        required: true
        default: bookworm
        type: choice
        options:
          - bookworm
          - jammy
      build_type:
        description: '构建类型'
        required: true
        default: server
        type: choice
        options:
          - minimal
          - server
          - desktop

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout Armbian Build Repo
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          path: armbian

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker image prune --all --force

      - name: Cache Armbian Sources
        uses: actions/cache@v4
        with:
          path: |
            armbian/sources
            armbian/toolchains
            ~/.cache/armbian
          key: ${{ runner.os }}-armbian-${{ inputs.board }}-${{ inputs.branch }}-${{ hashFiles('armbian/compile.sh') }}
          restore-keys: |
            ${{ runner.os }}-armbian-

      - name: Build Armbian Firmware
        working-directory: armbian
        run: |
          [ "${{ inputs.build_type }}" = "minimal" ] && BUILD_MINIMAL="yes" || BUILD_MINIMAL="no"
          [ "${{ inputs.build_type }}" = "desktop" ] && BUILD_DESKTOP="yes" || BUILD_DESKTOP="no"

          # Desktop 强制 xfce，防止 dialog
          if [ "${BUILD_DESKTOP}" = "yes" ]; then
            DESKTOP_ENVIRONMENT="xfce"
          fi

          echo "Starting build for ${{ inputs.board }}..."

          ./compile.sh build \
            BOARD=${{ inputs.board }} \
            BRANCH=${{ inputs.branch }} \
            RELEASE=${{ inputs.release }} \
            BUILD_MINIMAL=${BUILD_MINIMAL} \
            BUILD_DESKTOP=${BUILD_DESKTOP} \
            DESKTOP_ENVIRONMENT=${DESKTOP_ENVIRONMENT:-} \
            ENABLE_ZRAM=yes \
            INSTALL_DOCKER=yes \
            KERNEL_CONFIGURE=no \
            COMPRESS_OUTPUT=img

      - name: Organize Output
        run: |
          mkdir -p upload
          cp armbian/output/images/*.img* upload/ || true
          cp armbian/output/images/*.sha* upload/ || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Armbian-H618-${{ inputs.board }}-${{ inputs.branch }}
          path: upload/*
          if-no-files-found: error
          retention-days: 3

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: armbian-${{ inputs.board }}-${{ inputs.branch }}-${{ inputs.release }}-${{ inputs.build_type }}
          name: Armbian H618 ${{ inputs.board }} (${{ inputs.branch }})
          files: upload/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
